<?php
// cURL install check
if (!function_exists('curl_init')){
  exit("cURL isn't installed for ".phpversion());
}
$API_KEY = 'my-api-key';
$FILE_PATH = '/path/to/my/file.pdf';
$MIME_TYPE = 'application/pdf'; // change according to the file type
$ACCOUNT = 'my-account';
$VERSION = 'my-version';
$ENDPOINT = 'my-endpoint';

$MAX_RETRIES = 10;
$DELAY = 3;

// Open a cURL session
$curl_post = curl_init();

// Setup headers
$headers_post = array(
  "Authorization: Token $API_KEY"
);

// Add our file to the request
$data_post = array(
  "document" => new CURLFile(
    $FILE_PATH,
    $MIME_TYPE,
    substr($FILE_PATH, strrpos($FILE_PATH, "/") + 1)
  )
);

// Enqueueing URL
$url_post = "https://api.mindee.net/v1/products/$ACCOUNT/$ENDPOINT/v$VERSION/predict_async";

$options_post = array(
  CURLOPT_URL => $url_post,
  CURLOPT_HTTPHEADER => $headers_post,
  CURLOPT_POSTFIELDS => $data_post,
  CURLOPT_RETURNTRANSFER => true
);

// Set all options for the cURL request
curl_setopt_array(
  $curl_post,
  $options_post
);

// Execute the request & extract the query content into a variable
$json_post = curl_exec($curl_post);

if ($json_post == false) {
  exit("Remote url could not be reached.");
}

// Close the cURL session
curl_close($curl_post);

// Store the response as an array to allow for easier manipulations
$result_post = json_decode($json_post, true);

// Check for both server and upload errors
if (
  !isset($result_post['api_request']) ||
  !isset($result_post['api_request']['status_code']) ||
  !is_numeric($result_post['api_request']['status_code']) ||
  $result_post['api_request']['status_code'] > 399 ||
  $result_post['api_request']['status_code'] < 200
) {
  // If the file has been improperly sent, we stop the script.
  if (!isset($result_post['api_request']['status_code']) || !is_numeric($result_post['api_request']['status_code'])) {
    echo "Request couldn't be processed.\n";
  } else {
    echo "Error " . $result_post['api_request']['status_code'] . " was returned by the API during enqueueing.\n";

    // Print additional details, if there are any:
    if (isset($result_post['error']) && !empty($result_post['error'])) {
      echo "This was the given explanation:\n";
      echo "-------------------------\n";
      echo "Error Code:" . ($result_post['error']['code'] . "\n" ?? "\n");
      echo "Message:" . ($result_post['error']['message'] . "\n" ?? "\n");
      echo "Details:" . ($result_post['error']['details'] . "\n" ?? "\n");
      echo "-------------------------\n";
      exit(1);
    }
  }
} else {
  // Print a small confirmation that the document has been sent to a queue
  echo "Document successfully enqueued. Proceeding to fetch the result.\n";

  // Get the queue ID
  $queue_id = $result_post['job']['id'];
  // Enqueueing URL
  $url_get = "https://api.mindee.net/v1/products/$ACCOUNT/$ENDPOINT/v$VERSION/documents/queue/$queue_id";

  function call_curl($url, $api_key)
  {
    $curl_get = curl_init();

    // Setup headers
    $headers_get = array(
      "Authorization: Token $api_key"
    );

    $options_get = array(
      CURLOPT_URL => $url,
      CURLOPT_HTTPHEADER => $headers_get,
      CURLOPT_RETURNTRANSFER => true
    );
    curl_setopt_array($curl_get, $options_get);

    // Execute the request & extract the query content into a variable
    $json_response = curl_exec($curl_get);
    curl_close($curl_get);

    return json_decode($json_response, true);
  }

  $times_tried = 0;
  while ($times_tried < $MAX_RETRIES) {
    // Open a new cURL session for each attempt to retrieve the document

    $result_get = call_curl($url_get, $API_KEY);
    var_dump($result_get);
    if ($result_get['job']['status'] == "processed") {
      // echo json_encode($result_get, JSON_PRETTY_PRINT);
      echo array_keys($result_get);
      break;
    }
    $times_tried++;
    sleep($DELAY);
  }

  if ($times_tried == $MAX_RETRIES) {
    exit("Operation aborted, document not retrieved after $times_tried tries.\n");
  }
}
